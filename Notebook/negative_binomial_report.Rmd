---
title: "Negative Binomial Regression Fit Report"
output: html_document
date : 20250610 
classoption: landscape
---

## Project Summary

-   We are using data from the American Society of Microbiology's (ASM)
    12 published journals to investigate the relationship between the
    number of citations (variable 'is.referenced.by.count') a published
    scientific article receives and if the authors have included access
    to their raw sequencing data (variable 'da', data availability) in
    the manuscript.
-   We are trying to understand if publishing raw data helps to improve
    citation metrics. We have data from 2000-2024, and will also adjust
    for time published (variable 'age.in.months'), as older papers have
    had the opportunity to accumulate more citations over time.

```{r include=FALSE}
library(tidyverse)

# library(MASS)
# library(jtools)


all_journals <- read_csv("~/Documents/Schloss/Colovas_Data_Accessibility/Data/negative_binomial/all_data_glmnb_models.csv") 

container.title <-  all_journals %>% 
    filter(str_detect(coefficients, "container.title")) %>%  
    .[1:12,] %>%  
    mutate(container.title =
             str_remove_all(coefficients, "container.title")) %>%  
  select(container.title)


j_table<- 
    c("aem", "genomea", "iai", "jb", "jcm", "jmbe", "jvi", "mbio", "mra", "spectrum",  "msphere", "msystems")

for(i in 1:length(j_table)){
names(j_table)[i] <-  container.title[i,]
}


all_journals <- 
all_journals %>%
  mutate(pretty_name = str_replace_all(coefficients, "da_factorYes", "da_Yes"),
         pretty_name = str_replace_all(pretty_name, "log\\(age.in.months\\)", "log(time)"),
         pretty_name = str_remove_all(pretty_name, "container.title"), 
         pretty_name =  str_replace_all(pretty_name, j_table)) 



journal_list <- list.files( path = "~/Documents/Schloss/Colovas_Data_Accessibility/Data/negative_binomial", pattern = "negative_binomial_model", full.names = TRUE)


for (j in 1:length(journal_list)) { 
  journal <- str_split_i(journal_list[[j]], "_", 7) %>%  
              str_split_i(., "\\.", 1)
   assign(journal, read_csv(journal_list[[j]]))
}

```

```{r paged.print=TRUE}

opts <- options(knitr.kable.NA = " ")
knitr::kable(all_journals, digits = 3, col.names = gsub("_", " ", names(all_journals))) 
#, cap = "log(time) = log(age.in.months), shortened for ease of reading") 
  
#i want to filter all_journals to only show the significant p values

  
```

## How well do the models fit (by Cragg-Uhler pseduo R-squared metric)

### Model Formats 

-   Model format for all data from all journals
    MASS::glm.nb(is.referenced.by.count\~ da_factor +
    log(age.in.months) + container.title + container.title\*da_factor +
    log(age.in.months)\*da_factor +
    container.title\*log(age.in.months) +
    log(age.in.months)\*da_factor\*container.title, data =
    nsd_yes_metadata, link = log)

-   Use model format for data from each journal
    MASS::glm.nb(is.referenced.by.count\~ da_factor +
    log(age.in.months) + log(age.in.months)\*da_factor, data = \<each
    journal\>, link = log)

-   **Overall model fit with all data from all journals:**

    -   R\^2 value = 0.678
    -   Removal of top 1% of data: R\^2 value = 0.682
    -   Truncate data to last 5 years: R\^2 value = 0.660
    -   Truncate data to last 10 years: R\^2 value = 0.680
    -   **Summary :** Model fit by R\^2 metric does not change by
        removing the top 1% of data or truncating to data from the last
        5 or 10 years.

-   **Overall model fit for data from EACH journal individually:**

    -   4/12 journals have **overall model fit** with R\^2 \> 0.5

    -   4/12 journals have fit with R\^2 \> 0.5 with **top 1% of data
        removed**

    -   10/11 journals have model fits \>0.5 when **truncated to the
        last 5 years,** so they are better than their fit overall (one
        journal has no data from this period)

    -   8/12 journals have model fits \>0.5 when **truncated to the last
        10 years,** so they are better than their fit overall

    -   **Summary:** Data fits negative binomial model better with only
        more recent data considered.

```{r echo=FALSE}
all_journals %>%
  pivot_longer(cols = c(full, time_adj, at_one_year, at_five_years, five_years, at_ten_years, ten_years), names_to = "model", values_to = "model_value") %>%
  pivot_longer(cols = contains("pvalue"), names_to = "model_pvalues", values_to = "pvalue") %>% 
mutate(model_pvalues = str_remove_all(model_pvalues, "_pvalue")) %>%  
  filter(model == model_pvalues & pvalue <= 0.05) %>% 
  ggplot(aes(y = pretty_name, x = model_value)) + 
  geom_line(na.rm = TRUE) + 
  geom_point(aes(color = model), size  = 2, alpha = 0.75, na.rm = TRUE) 
```

## All journal model is resistant to changes from removing top 1% of data, but less resistant to changes from truncating at 5 and 10 years.

-   When working across the columns in the second table, we have
    coefficients on the left, followed by their values under the
    following conditions

    -   full_model_value = all data included in the model
    -   no_1percent_value = top 1% of data removed
    -   five_years_value = data truncated at 5 years in age of paper
    -   ten_years_value = data truncated at 10 years in age of paper
    -   **Note:** Journal of Microbiology and Biology Education(jmbe)
        has N=7 papers with new sequence data and has been excluded for
        these analyses, but is a part of the model, and appears as NAs
        in the table above.



```{r eval=FALSE, include=FALSE}
knitr::kable(iai, digits = 4)
each_journal %>% 
    rename(journal_abrev = name) %>% 
  pivot_longer(cols = all_journal_value:ten_years_value) %>%
  filter(name != "no_1p_value") %>% 
  ggplot(aes(x = coefficients, y = value)) + 
  geom_line(na.rm = TRUE) + 
  geom_point(aes(color = name), alpha = 0.75, na.rm = TRUE) + 
  facet_wrap(vars(journal_abrev), scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) 

#for each journal - 
# add journal name as a variable (pivoting)
# concatenate all tables
# graph the same way and facet them by journal

```

## Each journal model are semi-resistant to changes from removing top 1% of data, and even less resistant to changes from truncating at 5 and 10 years.

-   See above for mutations on these columns, but these models look less
    resistant to the transformation of removing the top 1% of data, and
    even less resistant to changes in coefficients from truncating at 5
    and 10 years of data.

