---
title: "Negative Binomial Regression Fit Report"
output: html_document
date : 20250610 
classoption: landscape
---

## Project Summary

-   We are using data from the American Society of Microbiology's (ASM)
    12 published journals to investigate the relationship between the
    number of citations (variable 'is.referenced.by.count') a published
    scientific article receives and if the authors have included access
    to their raw sequencing data (variable 'da', data availability) in
    the manuscript.
-   We are trying to understand if publishing raw data helps to improve
    citation metrics. We have data from 2000-2024, and will also adjust
    for time published (variable 'age.in.months'), as older papers have
    had the opportunity to accumulate more citations over time.

```{r include=FALSE}
library(tidyverse)

# library(MASS)
# library(jtools)


all_journals <- read_csv("~/Documents/Schloss/Colovas_Data_Accessibility/Data/negative_binomial/all_data_glmnb_models.csv") 

container.title <-  all_journals %>% 
    filter(str_detect(coefficients, "container.title")) %>%  
    .[1:12,] %>%  
    mutate(container.title =
             str_remove_all(coefficients, "container.title")) %>%  
  select(container.title)


j_table<- 
    c("aem", "genomea", "iai", "jb", "jcm", "jmbe", "jvi", "mbio", "mra", "spectrum",  "msphere", "msystems")

for(i in 1:length(j_table)){
names(j_table)[i] <-  container.title[i,]
}


all_journals <- 
all_journals %>%
  mutate(pretty_name = str_replace_all(coefficients, "da_factorYes", "da_Yes"),
         pretty_name = str_replace_all(pretty_name, "log\\(age.in.months\\)", "log(time)"),
         pretty_name = str_remove_all(pretty_name, "container.title"), 
         pretty_name =  str_replace_all(pretty_name, j_table)) 


each_journal <-  read_csv("~/Documents/Schloss/Colovas_Data_Accessibility/Data/negative_binomial/negative_binomial_models_each_journal.csv")

each_journal <- 
each_journal %>%
  mutate(pretty_name = str_replace_all(coefficients, "da_factorYes", "da_Yes"),
         pretty_name = str_replace_all(pretty_name, "log\\(age.in.months\\)", "log(time)"),
         pretty_name = str_remove_all(pretty_name, "container.title"), 
         pretty_name =  str_replace_all(pretty_name, j_table)) 


```

```{r paged.print=TRUE}

opts <- options(knitr.kable.NA = " ")
knitr::kable(all_journals, digits = 3, col.names = gsub("_", " ", names(all_journals))) 
#, cap = "log(time) = log(age.in.months), shortened for ease of reading") 
  
#i want to filter all_journals to only show the significant p values

  
```

## How well do the models fit (by Cragg-Uhler pseduo R-squared metric)

### Model Formats 

-   Model format for all data from all journals
    MASS::glm.nb(is.referenced.by.count\~ da_factor +
    log(age.in.months) + container.title + container.title\*da_factor +
    log(age.in.months)\*da_factor +
    container.title\*log(age.in.months) +
    log(age.in.months)\*da_factor\*container.title, data =
    nsd_yes_metadata, link = log)

-   Use model format for data from each journal
    MASS::glm.nb(is.referenced.by.count\~ da_factor +
    log(age.in.months) + log(age.in.months)\*da_factor, data = \<each
    journal\>, link = log)

-   **Overall model fit with all data from all journals:**

    -   R\^2 value = 0.678
    -   Removal of top 1% of data: R\^2 value = 0.682
    -   Truncate data to last 5 years: R\^2 value = 0.660
    -   Truncate data to last 10 years: R\^2 value = 0.680
    -   **Summary :** Model fit by R\^2 metric does not change by
        removing the top 1% of data or truncating to data from the last
        5 or 10 years.

-   **Overall model fit for data from EACH journal individually:**

    -   4/12 journals have **overall model fit** with R\^2 \> 0.5

    -   4/12 journals have fit with R\^2 \> 0.5 with **top 1% of data
        removed**

    -   10/11 journals have model fits \>0.5 when **truncated to the
        last 5 years,** so they are better than their fit overall (one
        journal has no data from this period)

    -   8/12 journals have model fits \>0.5 when **truncated to the last
        10 years,** so they are better than their fit overall

    -   **Summary:** Data fits negative binomial model better with only
        more recent data considered.

```{r echo=FALSE}
all_journals %>%
  pivot_longer(cols = c(full, time_adj, at_one_year, at_five_years, five_years, at_ten_years, ten_years), names_to = "model", values_to = "model_value") %>%
  pivot_longer(cols = contains("pvalue"), names_to = "model_pvalues", values_to = "pvalue") %>% 
mutate(model_pvalues = str_remove_all(model_pvalues, "_pvalue")) %>%  
  filter(model == model_pvalues & pvalue <= 0.05) %>% 
  ggplot(aes(y = pretty_name, x = model_value)) + 
  geom_line(na.rm = TRUE) + 
  geom_point(aes(color = model), size  = 2, alpha = 0.75, na.rm = TRUE)  + 
  labs(title = "Some significant changes in model coefficients occur\nwhen data are separated or adjusted by time", 
    subtitle = "Significant coefficients (p<=0.05) for\nnegative binomial modeling",
    x = "Coefficient Value", 
    y = "Coefficient Name")

```

## All journal model is resistant to changes from removing top 1% of data, but less resistant to changes from truncating at 5 and 10 years.

-   When working across the columns in the second table, we have
    coefficients on the left, followed by their values under the
    following conditions

    -   full_model_value = all data included in the model
    -   no_1percent_value = top 1% of data removed
    -   five_years_value = data truncated at 5 years in age of paper
    -   ten_years_value = data truncated at 10 years in age of paper
    -   **Note:** Journal of Microbiology and Biology Education(jmbe)
        has N=7 papers with new sequence data and has been excluded for
        these analyses, but is a part of the model, and appears as NAs
        in the table above.



```{r echo=FALSE}
opts <- options(knitr.kable.NA = " ")
knitr::kable(each_journal, digits = 3, col.names = gsub("_", " ", names(each_journal))) 

each_journal_plotting <- 
each_journal %>%
  pivot_longer(cols = c(journal, at_one_year, at_five_years, five_years, at_ten_years, ten_years), names_to = "model", values_to = "model_value") %>%
  pivot_longer(cols = contains("pvalue"), names_to = "model_pvalues", values_to = "pvalue") %>% 
mutate(model_pvalues = str_remove_all(model_pvalues, "_pvalue")) %>%  
  filter(model == model_pvalues & pvalue <= 0.05)

each_journal_plotting %>% 
  ggplot(aes(y = pretty_name, x = model_value)) + 
  geom_line(na.rm = TRUE) + 
  geom_point(aes(color = names, shape = model), size  = 2, alpha = 0.75, na.rm = TRUE)  + 
  labs(title = "There is not a lot of significant change in model\ncoefficients when data is separated by journal or time is truncated", 
    subtitle = "Significant coefficients (p<=0.05) for\nnegative binomial modeling by journal",
    x = "Coefficient Value", 
    y = "Coefficient Name")


each_journal_plotting %>% 
  ggplot(aes(y = pretty_name, x = model_value)) + 
  geom_line(na.rm = TRUE) + 
  geom_point(aes(color = model), size  = 2, alpha = 0.75, na.rm = TRUE)  +
  facet_wrap(vars(names)) +
  labs(title = "There is not a lot of significant change in model\ncoefficients when data is separated by journal or time is truncated", 
    subtitle = "Significant coefficients (p<=0.05) for\nnegative binomial modeling by journal",
    x = "Coefficient Value", 
    y = "Coefficient Name")



```

## Each journal model are semi-resistant to changes from removing top 1% of data, and even less resistant to changes from truncating at 5 and 10 years.

-   See above for mutations on these columns, but these models look less
    resistant to the transformation of removing the top 1% of data, and
    even less resistant to changes in coefficients from truncating at 5
    and 10 years of data.

